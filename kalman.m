clear all
thetav=[0	0	0	0	0	0	0	0	0	0	0 0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0 -0.4	-0.8	-1.2	-1.6	-2	-2.4	-2.8	-3.2	-3.6	-4	-4.4	-4.8	-5.2	-5.6	-6	-6.4	-6.8	-7.2	-7.6	-8	-8.4	-8.8	-9.2	-9.6	-10	-10.4	-10.8	-11.2	-11.6	-12 -11.05	-10.1	-9.15	-8.2	-7.25	-6.3	-5.35	-4.4	-3.45	-2.5	-1.55	-0.6	0.35	1.3	2.25	3.2	4.15	5.1	6.05	7 6.834	6.668	6.502	6.336	6.17	6.004	5.838	5.672	5.506	5.34	5.174	5.008	4.842	4.676	4.51	4.344	4.178	4.012	3.846	3.68	3.514	3.348	3.182	3.016	2.85	2.684	2.518	2.352	2.186	2.02 2.033	2.066	2.099	2.132	2.165	2.198	2.231	2.264	2.297	2.33	2.363	2.396	2.429	2.462	2.495 2.3334	2.1668	2.0002	1.8336	1.667	1.5004	1.3338	1.1672	1.0006	0.834	0.6674	0.5008	0.3342	0.1676	0.001 0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0 -0.28	-0.56	-0.84	-1.12	-1.4	-1.68	-1.96	-2.24	-2.52	-2.8	-3.08	-3.36	-3.64	-3.92	-4.2	-4.48	-4.76	-5.04	-5.32	-5.6	-5.88	-6.16	-6.44	-6.72	-7 -6.56	-6.12	-5.68	-5.24	-4.8	-4.36	-3.92	-3.48	-3.04	-2.6	-2.16	-1.72	-1.28	-0.84	-0.4	0.04	0.48	0.92	1.36	1.8	2.24	2.68	3.12	3.56	4 3.85	3.7	3.55	3.4	3.25	3.1	2.95	2.8	2.65	2.5	2.35	2.2	2.05	1.9	1.75	1.6	1.45	1.3	1.15	1 1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1 0.95	0.9	0.85	0.8	0.75	0.7	0.65	0.6	0.55	0.5	0.45	0.4	0.35	0.3	0.25	0.2	0.15	0.1	0.05	0];
rudder=[0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0 0	-0.05	-0.1	-0.15	-0.2	-0.25 -0.25	-0.25	-0.25	-0.25	-0.25 -0.25	-0.2	-0.15	-0.1	-0.05	0	0.05	0.1	0.15	0.2	0.25 0.25	0.25	0.25	0.25	0.25	0.25	0.25	0.25	0.25	0.25 0.25	0.225	0.2	0.175	0.15	0.125	0.1	0.075	0.05	0.025	0 0	-0.05	-0.045	-0.04	-0.035	-0.03	-0.025	-0.02	-0.015	-0.01	-0.005	0	0.005	0.01	0.015	0.02	0.025	0.03	0.035	0.04	0.045	0.05 0.05	0.0455	0.041	0.0365	0.032	0.0275	0.023	0.0185	0.014	0.0095	0.005	0.0005	-0.004	-0.0085	-0.013	-0.0175	-0.022	-0.0265	-0.031	-0.0355	-0.04 -0.04	-0.04	-0.04	-0.04	-0.04	-0.04	-0.04	-0.04	-0.04	-0.04 -0.033	-0.026	-0.019	-0.012	-0.005	0.002	0.009	0.016	0.023	0.03	0.037	0.044	0.051	0.058	0.065	0.072	0.079	0.086	0.093	0.1 0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	0.1	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15	-0.15 -0.15	-0.09	-0.03	0.03	0.09	0.15 0.15	0.15	0.15	0.15	0.15	0.15	0.15	0.15	0.15 0.15	0.12	0.09	0.06	0.03	0 0 -0.01	-0.02	-0.03	-0.04	-0.05 -0.05	-0.0425	-0.035	-0.0275	-0.02	-0.0125	-0.005	0.0025	0.01	0.0175	0.025	0.0325	0.04	0.0475	0.055	0.0625	0.07	0.0775	0.085	0.0925	0.1	0.1	0.0952	0.0904	0.0856	0.0808	0.076	0.0712	0.0664	0.0616	0.0568	0.052	0.0472	0.0424	0.0376	0.0328	0.028	0.0232	0.0184	0.0136	0.0088	0.004	-0.0008	-0.0056	-0.0104	-0.0152	-0.02 -0.02	-0.016	-0.012	-0.008	-0.004	0 0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0 0 0 0 0 0 0 0 0 0 0]	;			
thetaa=[0	0	0	0	0	0 0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0 -0.6	-1.2	-1.8	-2.4	-3	-3.6	-4.2	-4.8	-5.4	-6 -6.066	-6.132	-6.198	-6.264	-6.33	-6.396	-6.462	-6.528	-6.594	-6.66	-6.726	-6.792	-6.858	-6.924	-6.99 -5.3	-3.6	-1.9	-0.2	1.5	3.2	4.9	6.6	8.3	10 9.8	9.6	9.4	9.2	9	8.8	8.6	8.4	8.2	8 7.2	6.4	5.6	4.8	4	3.2	2.4	1.6	0.8	0 -0.8	-1.6	-2.4	-3.2	-4	-3.8	-3.6	-3.4	-3.2	-3	-2.8	-2.6	-2.4	-2.2	-2	-1.8	-1.6	-1.4	-1.2	-1	-0.8	-0.6	-0.4	-0.2	0 0.15	0.3	0.45	0.6	0.75	0.9	1.05	1.2	1.35	1.5	1.15	0.8	0.45	0.1	-0.25	-0.6	-0.95	-1.3	-1.65	-2	-1.8	-1.6	-1.4	-1.2	-1	-0.8	-0.6	-0.4	-0.2	0 0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0 -0.33	-0.66	-0.99	-1.32	-1.65	-1.98	-2.31	-2.64	-2.97	-3.3	-3.63	-3.96	-4.29	-4.62	-4.95 -4.8	-4.6	-4.4	-4.2	-4 -4	-4	-4	-4	-4	-4	-4	-4	-4	-4 -3	-2	-1	0	1	2	3	4	5	6 6	6	6	6	6 5.1	4.2	3.3	2.4	1.5	0.6	-0.3	-1.2	-2.1	-3 -3.2	-3.4	-3.6	-3.8	-4	-3.8	-3.6	-3.4	-3.2	-3	-2.8	-2.6	-2.4	-2.2	-2	-1.8	-1.6	-1.4	-1.2	-1	-0.8	-0.6	-0.4	-0.2	0	0.2	0.4	0.6	0.8	1 0.8	0.6	0.4	0.2	0	-0.2	-0.4	-0.6	-0.8	-1 -0.8	-0.6	-0.4	-0.2	0 0	0	0	0	0	0	0	0	0	0	0	0	0	0 0 0 0 0 0 0 0 0 0];																								
row3=[1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1];
k=0:0.1:30;
phi=[thetav' rudder' row3'];
phi(1,:,:);
phif=phi';
phif(:,1,:)
Q=thetaa';
theta1=[0;0;0];  
%theta1=inv(phi'*phi)*phi'*Q;
I=eye(3);
P1=100.*I;
phi0=zeros(1,3);
P(:,:,1)=P1;
theta(:,:,1)=theta1;
N=301;
for k=2:N
    K(:,:,k)=(P(:,:,k-1)*phif(:,k,:))/(1+phif(:,k,:)'*P(:,:,k-1)*phif(:,k,:));
    P(:,:,k)=(1-K(:,:,k)'*phif(:,k,:))*P(:,:,k-1);
    epsilon(:,k)=thetaa(k)-theta(:,:,1)'*phif(:,k,:);
    theta(:,:,k)=theta(:,:,k-1)+K(:,:,k)*epsilon(:,k);
    x1(k)=K(1,k);
    x2(k)=P(2,k);
    x3(k)=P(3,k);
    y1(k)=theta(1,k);
    y2(k)=theta(2,k);
    y3(k)=theta(3,k);
end
t=0:0.1:30;
figure(1)
plot(t,y1)
xlabel('Time [s]')
ylabel('a22')
title('Rotational drag coefficient')
figure(2)
plot(t,y2)
xlabel('Time [s]')
ylabel('b2')
title('rudder control authority')
figure(3)
plot(t,y3)
xlabel('Time [s]')
ylabel('C0')
title('Steady-state rudder deflection')
figure(4)
plot(t,x1,t,x2,t,x3)
xlabel('Time [s]')
ylabel('value')
title('Kalman Gain')